name: CI/CD Pipeline (Direct Build)

on:
  push:
    branches: [ "jin_part" ] # main ë¸Œëœì¹˜ì— ì½”ë“œê°€ ì˜¬ë¼ì˜¤ë©´ ìë™ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸš§ ë°°í¬ ì‹œì‘: ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤."
            
            # 1. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
            cd /home/ubuntu/OpenCloset_Back
            
            # 2. ìµœì‹  ì½”ë“œ ë°›ê¸° (ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ê°•ì œ ë™ê¸°í™”)
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # 3. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x gradlew
            
            # 4. ìë°” ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±)
            echo "â˜• ìë°” ë¹Œë“œ ì‹œì‘..."
            ./gradlew clean build -x test
            
            # 5. ë„ì»¤ ì»¨í…Œì´ë„ˆ ì¬ë°°í¬
            # --build ì˜µì…˜: ì½”ë“œê°€ ë°”ë€Œì—ˆìœ¼ë‹ˆ ì´ë¯¸ì§€ë¥¼ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
            echo "ğŸ³ ë„ì»¤ ì»¨í…Œì´ë„ˆ ì¬ë°°í¬..."
            sudo docker compose up -d --build
            
            sudo docker image prune -f
            
            echo "âœ… ë°°í¬ ì™„ë£Œ! "