name: CI/CD Pipeline (Direct Build)

on:
  push:
    branches: [ "main", "jin_part" ] # main ë˜ëŠ” jin_part ë¸Œëœì¹˜ì— ì½”ë“œê°€ ì˜¬ë¼ì˜¤ë©´ ìë™ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e 
            
            echo "ğŸš§ ë°°í¬ ì‹œì‘: ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤."
            
            cd /home/ubuntu/OpenCloset_Back
            
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            git fetch --all
            git reset --hard origin/jin_part
            git pull origin jin_part

            chmod +x gradlew

            echo "â˜• ìë°” ë¹Œë“œ ì‹œì‘..."
            ./gradlew clean build -x test
            
            echo "ğŸ³ ë„ì»¤ ì»¨í…Œì´ë„ˆ ì¬ë°°í¬..."
            sudo docker compose up -d --build
            
            sudo docker image prune -f
            
            echo "âœ… ë°°í¬ ì™„ë²½í•˜ê²Œ ì„±ê³µ!"